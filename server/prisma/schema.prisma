enum HistoryType {
  QUERY
  ISSUE
  UPDATE
  GENERAL_NOTE
  COMMENDATION
  DISCIPLINARY
}

enum Severity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum HistoryStatus {
  OPEN
  CLOSED
  ARCHIVED
}
// --- MISSING ENUMS ---
// --- MISSING ENUMS ---
enum AppraisalStatus {
  PENDING_SELF
  PENDING_MANAGER
  SUBMITTED
  FINALIZED
  COMPLETED
}

// --- MISSING MODELS (MINIMAL STUBS) ---
model KpiSheet {
  month      Int
  year       Int
  lockedAt   DateTime?
  id         String   @id @default(uuid())
  title      String
  employee   User?   @relation("EmployeeKPIs", fields: [employeeId], references: [id])
  employeeId String?
  reviewer   User?   @relation("ReviewerKPIs", fields: [reviewerId], references: [id])
  reviewerId String?
  totalScore Float?
  status     KpiStatus? @default(DRAFT)
  isLocked   Boolean   @default(false)
  createdAt  DateTime  @default(now())
  items      KpiItem[]
}

model KpiItem {
  targetValue Float
  weight      Float @default(1.0)
  actualValue Float
  id        String   @id @default(uuid())
  sheet     KpiSheet @relation(fields: [sheetId], references: [id])
  sheetId   String
  name      String
  category  String @default("General")
  description String @default("")
  score     Float?
  createdAt DateTime @default(now())
  lastEntryDate DateTime?
}
// --- ASSET MODULE ---
enum AssetStatus {
  AVAILABLE
  ASSIGNED
  MAINTENANCE
  RETIRED
}

enum AssetType {
  LAPTOP
  DESKTOP
  MONITOR
  PHONE
  TABLET
  VEHICLE
  PERIPHERAL
  OTHER
}

model Asset {
  id          String      @id @default(uuid())
  name        String
  description String?
  isCompanyProperty Boolean @default(true)
  serialNumber String    @unique
  make        String?
  model       String?
  type        AssetType
  status      AssetStatus @default(AVAILABLE)
  purchaseDate DateTime?
  warrantyExpiry DateTime?
  assignments AssetAssignment[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

model AuditLog {
  id        String   @id @default(uuid())
  user      User?   @relation(fields: [userId], references: [id])
  userId    String?
  action    String?
  entity    String?
  entityId  String?
  details   String?
  ipAddress String?
  createdAt DateTime @default(now())
}

model EmployeeHistory {
  id        String   @id @default(uuid())
  employee  User?   @relation("EmployeeHistory", fields: [employeeId], references: [id])
  employeeId String?
  createdBy User?   @relation("CreatedHistory", fields: [createdById], references: [id])
  createdById String?
  title      String?
  description String?
  change     String?
  type       HistoryType?
  severity   Severity?
  status     HistoryStatus? @default(OPEN)
  loggedById String?
  loggedBy   User? @relation("LoggedByHistory", fields: [loggedById], references: [id])
  createdAt  DateTime @default(now())
}

model AssetAssignment {
    returnedAt DateTime?
    details   String?
    status      HistoryStatus? @default(OPEN)
    conditionOnAssign String?
    conditionOnReturn String?
    loggedById  String?
    loggedBy    User? @relation("LoggedByAssignments", fields: [loggedById], references: [id])
    id        String   @id @default(uuid())
    user      User?   @relation("UserAssignments", fields: [userId], references: [id])
    userId    String?
    asset     Asset?  @relation(fields: [assetId], references: [id])
    assetId   String?
    assignedAt DateTime @default(now())
}

// This is your Database Schema. 
// It defines the flow from User Hierarchy to Performance Data.

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}




// --- ENUMS (Strict Categories) ---
enum Role {
  MD
  SUPERVISOR
  EMPLOYEE
  HR_ADMIN
  SUPER_ADMIN
}

enum EmploymentStatus {
  ACTIVE
  PROBATION
  NOTICE_PERIOD
  TERMINATED
}

enum CycleStatus {
  DRAFT
  ACTIVE
  LOCKED
  ARCHIVED
}

enum CycleType {
  QUARTERLY
  ANNUAL
}

enum KpiStatus {
  DRAFT
  PENDING_APPROVAL
  ACTIVE
  LOCKED          // The 7-day lock state
  ARCHIVED
}

enum LeaveStatus {
  PENDING_RELIEVER
  PENDING_MANAGER
  APPROVED
  REJECTED
  CANCELLED
}

enum Currency {
  USD
  GHS
  GNF
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String
  fullName      String
  role          Role     @default(EMPLOYEE)
  employeeCode  String?  @unique
  status        EmploymentStatus @default(ACTIVE)
  position      String?
  departmentId  Int?
  departmentObj Department? @relation("DepartmentEmployees", fields: [departmentId], references: [id])
  jobTitle      String
  joinDate      DateTime?
  employmentType String?
  dob             DateTime?
  gender          String?
  nationalId      String?
  contactNumber   String?
  address         String?
  profilePhoto    String?
  nextOfKinName     String?
  nextOfKinRelation String?
  nextOfKinContact  String?
  avatarUrl     String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  salary          Decimal?  @db.Decimal(10, 2)
  currency        Currency  @default(GHS)
  nationalIdDocUrl String?
  leaveBalance    Float   @default(0)
  leaveAllowance  Float   @default(24)
  leaveAccruedAt  DateTime?
  supervisorId  String?
  supervisor    User?     @relation("Hierarchy", fields: [supervisorId], references: [id])
  subordinates  User[]    @relation("Hierarchy")
  kpiSheets     KpiSheet[]      @relation("EmployeeKPIs")
  kpiReviews    KpiSheet[]      @relation("ReviewerKPIs")
  leaves        LeaveRequest[]  @relation("EmployeeLeaves")
  reliefRequests LeaveRequest[] @relation("RelieverLeaves")
  auditLogs     AuditLog[]
  myAppraisals      Appraisal[] @relation("MyAppraisals")
  managerAppraisals Appraisal[] @relation("ManagerAppraisals")
  historyLogs       EmployeeHistory[] @relation("EmployeeHistory")
  createdHistory    EmployeeHistory[] @relation("CreatedHistory")
  userAssignments   AssetAssignment[] @relation("UserAssignments")
  loggedByAssignments AssetAssignment[] @relation("LoggedByAssignments")
  loggedByHistory    EmployeeHistory[] @relation("LoggedByHistory")
  managesDepartment Department[] @relation("DepartmentManager")
}

model Department {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  managerId String?
  manager   User?    @relation("DepartmentManager", fields: [managerId], references: [id])
  employees User[]   @relation("DepartmentEmployees")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}



model LeaveRequest {
  id              String      @id @default(uuid())
  employeeId      String
  employee        User        @relation("EmployeeLeaves", fields: [employeeId], references: [id])
   
  startDate       DateTime
  endDate         DateTime
  leaveDays       Float       @default(0)
  reason          String
   
  // The "Handover Protocol"
  relieverId      String?
  reliever        User?       @relation("RelieverLeaves", fields: [relieverId], references: [id])
   
  status          LeaveStatus @default(PENDING_RELIEVER)
  managerComment  String?

  createdAt       DateTime    @default(now())
}



// --- UNIVERSAL CYCLE ENGINE ---
model Cycle {
  id        String      @id @default(uuid())
  name      String      // e.g., "Q1 2024", "Annual 2024"
  type      CycleType
  startDate DateTime
  endDate   DateTime
  status    CycleStatus @default(DRAFT)
  
  // Relations
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  
  appraisals Appraisal[]
}

// --- APPRAISAL MODULE ---

model Competency {
    id          String   @id @default(uuid())
    name        String
    description String
    weight      Float    @default(1.0)
    
    ratings     AppraisalRating[]
}

model Appraisal {
    id          String   @id @default(uuid())
    
    employeeId  String
    employee    User     @relation("MyAppraisals", fields: [employeeId], references: [id])
    
    reviewerId  String // Manager at time of creation
    reviewer    User     @relation("ManagerAppraisals", fields: [reviewerId], references: [id])
    
    cycleId     String
    cycle       Cycle    @relation(fields: [cycleId], references: [id])
    
    status      AppraisalStatus @default(PENDING_SELF)
    finalScore  Float?
    
    ratings     AppraisalRating[]
    
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt
    
    @@unique([employeeId, cycleId]) // One appraisal per cycle per employee
}

model AppraisalRating {
    id              String      @id @default(uuid())
    appraisalId     String
    appraisal       Appraisal   @relation(fields: [appraisalId], references: [id])
    
    competencyId    String
    competency      Competency  @relation(fields: [competencyId], references: [id])
    
    selfScore       Float?
    managerScore    Float?
    
    selfComment     String?
    managerComment  String?
    
    updatedAt       DateTime    @updatedAt
    
    @@unique([appraisalId, competencyId])
}

// --- SAAS / WHITE LABEL ENGINE ---
model SystemSettings {
    id              String @id @default(uuid())
    companyName     String @default("Nexus HRM")
    companyLogoUrl  String?
    
    // Branding
    primaryColor    String @default("#4F46E5") // Nexus Blue
    secondaryColor  String @default("#1E293B") // Slate 800
    accentColor     String @default("#F59E0B") // Amber 500
    
    // Subscription
    plan            String @default("FREE") // FREE, PRO, ENTERPRISE
    paymentLink     String?
    lastPaymentDate DateTime?
    subscriptionStatus String @default("ACTIVE")
    
    // Security / Kill Switch
    isMaintenanceMode Boolean @default(false) // Blocks normal users
    securityLockdown  Boolean @default(false) // Stricter lockout
    
    updatedAt       DateTime @updatedAt
}