// This is your Database Schema. 
// It defines the flow from User Hierarchy to Performance Data.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ENUMS (Strict Categories) ---

enum Role {
  MD
  SUPERVISOR
  EMPLOYEE
  HR_ADMIN
  SUPER_ADMIN
}

enum EmploymentStatus {
  ACTIVE
  PROBATION
  NOTICE_PERIOD
  TERMINATED
}

enum CycleStatus {
  DRAFT
  ACTIVE
  LOCKED
  ARCHIVED
}

enum CycleType {
  QUARTERLY
  ANNUAL
}

enum KpiStatus {
  DRAFT
  PENDING_APPROVAL
  ACTIVE
  LOCKED          // The 7-day lock state
  ARCHIVED
}

enum LeaveStatus {
  PENDING_RELIEVER // Step 1: Waiting for colleague to accept
  PENDING_MANAGER  // Step 2: Waiting for supervisor
  APPROVED
  REJECTED
}

enum AppraisalStatus {
  PENDING_SELF
  PENDING_MANAGER
  COMPLETED
  ARCHIVED
}

enum HistoryType {
  QUERY
  DISCIPLINARY
  COMMENDATION
  GENERAL_NOTE
  ISSUE
}

enum Severity {
  LOW
  MEDIUM
  CRITICAL
}

enum HistoryStatus {
  OPEN
  RESOLVED
  CLOSED
}

enum AssetType {
  LAPTOP
  PHONE
  VEHICLE
  PERIPHERAL
  OTHER
}

enum AssetStatus {
  AVAILABLE
  ASSIGNED
  MAINTENANCE
  RETIRED
}

// --- MODELS ---

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String    // Renamed from 'password' for clarity
  fullName      String
  role          Role      @default(EMPLOYEE)
  
  // --- Employee Master Data ---
  employeeCode  String?   @unique // Nullable for existing users, should be required for new
  status        EmploymentStatus @default(ACTIVE)
  position      String?   // Distinct from Role (e.g. "Senior Backend Engineer")
  department    String
  jobTitle      String    // Keeping existing field, but 'position' might replace it long term. matching schema to prompt.
  joinDate      DateTime? 
  employmentType String?  // e.g. "Permanent", "Contract"

  // --- Personal Details ---
  dob             DateTime?
  gender          String?   // "Male", "Female", "Other"
  nationalId      String?   // e.g. SSN, NIC
  contactNumber   String?
  address         String?
  profilePhoto    String?   // To replace avatarUrl eventually, or use as specific full photo
  
  // --- Next of Kin ---
  nextOfKinName     String?
  nextOfKinRelation String?
  nextOfKinContact  String?

  avatarUrl     String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // --- Digital Employee File ---
  salary          Decimal?  @db.Decimal(10, 2) // MD Only
  currency        Currency  @default(GHS)
  nationalIdDocUrl String?
  
  // Hierarchy Logic
  supervisorId  String?
  supervisor    User?     @relation("Hierarchy", fields: [supervisorId], references: [id])
  subordinates  User[]    @relation("Hierarchy")

  // Data Relations
  kpiSheets     KpiSheet[]      @relation("EmployeeKPIs")
  kpiReviews    KpiSheet[]      @relation("ReviewerKPIs")
  leaves        LeaveRequest[]  @relation("EmployeeLeaves")
  reliefRequests LeaveRequest[] @relation("RelieverLeaves")
   
  auditLogs     AuditLog[]      // Actions performed by this user

  // Appraisal Relations
  myAppraisals      Appraisal[] @relation("MyAppraisals")
  managerAppraisals Appraisal[] @relation("ManagerAppraisals")
  
  // History Relations
  historyLogs       EmployeeHistory[] @relation("EmployeeHistory")
  createdHistory    EmployeeHistory[] @relation("CreatedHistory")

  // Asset Relations
  assets            AssetAssignment[]
}

enum Currency {
  USD
  GHS
  GNF
}

// --- EMPLOYEE HISTORY / PORTAL ---
model EmployeeHistory {
  id          String   @id @default(uuid())
  
  employeeId  String
  employee    User     @relation("EmployeeHistory", fields: [employeeId], references: [id])
  
  loggedById  String
  loggedBy    User     @relation("CreatedHistory", fields: [loggedById], references: [id])
  
  type        HistoryType
  title       String
  description String
  
  severity    Severity     @default(LOW)
  status      HistoryStatus @default(OPEN) // For queries/issues
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// --- ASSET MANAGEMENT MODULE ---
model Asset {
  id            String    @id @default(uuid())
  name          String?   // E.g. "MacBook Pro 16"
  description   String?   // E.g. "Space Grey, M1 Pro, 16GB"
  isCompanyProperty Boolean @default(true)
  serialNumber  String   @unique
  type          AssetType
  make          String
  model         String
  purchaseDate  DateTime?
  warrantyExpiry DateTime?
  status        AssetStatus @default(AVAILABLE)

  assignments   AssetAssignment[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model AssetAssignment {
  id          String    @id @default(uuid())
  
  assetId     String
  asset       Asset     @relation(fields: [assetId], references: [id])
  
  userId      String
  user        User      @relation(fields: [userId], references: [id])
  
  assignedAt  DateTime  @default(now())
  returnedAt  DateTime? // Null means currently assigned
  
  conditionOnAssign String?
  conditionOnReturn String?

  @@index([userId])
  @@index([assetId])
}

// --- AUDIT LOGGING ---
model AuditLog {
  id        String   @id @default(uuid())
  userId    String?  // Nullable because system might purge deleted users, or system actions? Keep it linked if possible.
  action    String   // e.g. "CREATE_ASSET", "UPDATE_EMPLOYEE"
  entity    String   // e.g. "Asset"
  entityId  String   // UUID of the entity
  details   Json?    // Flexible JSON storage for diffs/metadata
  ipAddress String?
  createdAt DateTime @default(now())

  user      User?    @relation(fields: [userId], references: [id])
}

// The "Balanced Scorecard" Container
model KpiSheet {
  id              String    @id @default(uuid())
  title           String    
  month           Int
  year            Int
   
  employeeId      String
  employee        User      @relation("EmployeeKPIs", fields: [employeeId], references: [id])
   
  reviewerId      String
  reviewer        User      @relation("ReviewerKPIs", fields: [reviewerId], references: [id])

  status          KpiStatus @default(DRAFT)
  totalScore      Float?    
   
  isLocked        Boolean   @default(false) 
  lockedAt        DateTime? 

  items           KpiItem[]
   
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

// Individual Targets
model KpiItem {
  id              String    @id @default(uuid())
  sheetId         String
  sheet           KpiSheet  @relation(fields: [sheetId], references: [id], onDelete: Cascade)

  category        String    
  description     String    
   
  weight          Float     
  targetValue     Float     
  actualValue     Float     
   
  score           Float?    
   
  feedback        String?   
   
  lastEntryDate   DateTime  @default(now()) 
}

model LeaveRequest {
  id              String      @id @default(uuid())
  employeeId      String
  employee        User        @relation("EmployeeLeaves", fields: [employeeId], references: [id])
   
  startDate       DateTime
  endDate         DateTime
  reason          String
   
  // The "Handover Protocol"
  relieverId      String?
  reliever        User?       @relation("RelieverLeaves", fields: [relieverId], references: [id])
   
  status          LeaveStatus @default(PENDING_RELIEVER)
  managerComment  String?

  createdAt       DateTime    @default(now())
}



// --- UNIVERSAL CYCLE ENGINE ---
model Cycle {
  id        String      @id @default(uuid())
  name      String      // e.g., "Q1 2024", "Annual 2024"
  type      CycleType
  startDate DateTime
  endDate   DateTime
  status    CycleStatus @default(DRAFT)
  
  // Relations
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  
  appraisals Appraisal[]
}

// --- APPRAISAL MODULE ---

model Competency {
    id          String   @id @default(uuid())
    name        String
    description String
    weight      Float    @default(1.0)
    
    ratings     AppraisalRating[]
}

model Appraisal {
    id          String   @id @default(uuid())
    
    employeeId  String
    employee    User     @relation("MyAppraisals", fields: [employeeId], references: [id])
    
    reviewerId  String // Manager at time of creation
    reviewer    User     @relation("ManagerAppraisals", fields: [reviewerId], references: [id])
    
    cycleId     String
    cycle       Cycle    @relation(fields: [cycleId], references: [id])
    
    status      AppraisalStatus @default(PENDING_SELF)
    finalScore  Float?
    
    ratings     AppraisalRating[]
    
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt
    
    @@unique([employeeId, cycleId]) // One appraisal per cycle per employee
}

model AppraisalRating {
    id              String      @id @default(uuid())
    appraisalId     String
    appraisal       Appraisal   @relation(fields: [appraisalId], references: [id])
    
    competencyId    String
    competency      Competency  @relation(fields: [competencyId], references: [id])
    
    selfScore       Float?
    managerScore    Float?
    
    selfComment     String?
    managerComment  String?
    
    updatedAt       DateTime    @updatedAt
    
    @@unique([appraisalId, competencyId])
}

// --- SAAS / WHITE LABEL ENGINE ---
model SystemSettings {
    id              String @id @default(uuid())
    companyName     String @default("Nexus HRM")
    companyLogoUrl  String?
    
    // Branding
    primaryColor    String @default("#4F46E5") // Nexus Blue
    secondaryColor  String @default("#1E293B") // Slate 800
    accentColor     String @default("#F59E0B") // Amber 500
    
    // Subscription
    plan            String @default("FREE") // FREE, PRO, ENTERPRISE
    paymentLink     String?
    lastPaymentDate DateTime?
    subscriptionStatus String @default("ACTIVE")
    
    // Security / Kill Switch
    isMaintenanceMode Boolean @default(false) // Blocks normal users
    securityLockdown  Boolean @default(false) // Stricter lockout
    
    updatedAt       DateTime @updatedAt
}